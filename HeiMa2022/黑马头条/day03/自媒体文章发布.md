# 自媒体文章发布

![image-20220710135239415](assets\image-20220710135239415.png)





### 1)自媒体前后端搭建

#### 1.1)后台搭建

![image-20210426110728659](自媒体文章发布.assets\image-20210426110728659.png)

**实现步骤**

- 将heima-leadnews-wemedia导入到heima-leadnew-service下

  - 检查配置文件（本地和线上的）

- 将heima-leadnews-wemedia-gateway导入到heima-leadnews-gateway下

  - 检查配置文件（本地和线上的）

- 导入数据库 leadnews_wemedia.sql

- 导入pojo和dto

- 启动工程

- 启动前端联调测试

  

**后台服务**

①：执行leadnews-wemedia.sql脚本

②：找到heima-leadnews-service工程下，的heima-leadnews-wemedia模块；

添加bootstrap.yml配置

```yaml
server:
  port: 51803
spring:
  application:
    name: leadnews-wemedia
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
      config:
        server-addr: localhost:8848
        file-extension: yml
```

在nacos中创建leadnews-wemedia.yaml文件，添加对应的配置

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_wemedia?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: root
    password: root
# 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # 设置别名包扫描路径，通过该属性可以给包中的类注册别名
  type-aliases-package: com.heima.model.media.pojos
```

③：在资料中找到类文件夹

拷贝wemedia文件夹到heima-leadnews-model模块下的com.heima.model



**后台网关**

①：找到heima-leadnews-gateway工程下的heima-leadnews-wemedia-gateway模块

添加bootstrap.yml配置

```yaml
server:
  port: 51602
spring:
  application:
    name: leadnews-wemedia-gateway
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
      config:
        server-addr: localhost:8848
        file-extension: yml
```

在nacos中创建leadnews-wemedia.yaml文件，添加对应的配置

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # 匹配所有请求
            allowedOrigins: "*" #跨域处理 允许所有的域
            allowedMethods: # 支持的方法
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # 平台管理
        - id: wemedia
          uri: lb://leadnews-wemedia
          predicates:
            - Path=/wemedia/**
          filters:
            - StripPrefix= 1
```

#### 1.2)前台搭建

![image-20210426110913007](自媒体文章发布.assets\image-20210426110913007.png)

①：启动nginx，在浏览器中访问localhost:8802即可；

②：启动自媒体微服务和对应网关。

#### 1.3)联调测试登录功能

![image-20220628001410451](assets\image-20220628001410451.png)

### 2)自媒体素材管理

#### 2.1)素材上传

##### 2.2.1)需求分析

图片上传的页面，首先是展示素材信息，可以点击图片上传，弹窗后可以上传图片。

![image-20210426144327206](自媒体文章发布.assets\image-20210426144327206.png)

##### 2.2.2)实现思路

![image-20220710152806880](assets\image-20220710152806880.png)

##### 2.2.3)素材管理-图片上传-表结构

媒体图文素材信息表wm_material

![image-20210426144500239](自媒体文章发布.assets\image-20210426144500239.png)

对应实体类：

```java
package com.heima.model.wemedia.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * 自媒体图文素材信息表
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("wm_material")
public class WmMaterial implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * 自媒体用户ID
     */
    @TableField("user_id")
    private Integer userId;

    /**
     * 图片地址
     */
    @TableField("url")
    private String url;

    /**
     * 素材类型
            0 图片
            1 视频
     */
    @TableField("type")
    private Short type;

    /**
     * 是否收藏
     */
    @TableField("is_collection")
    private Short isCollection;

    /**
     * 创建时间
     */
    @TableField("created_time")
    private Date createdTime;

}
```



##### 2.2.4)接口定义

|          | **说明**                        |
| -------- | ------------------------------- |
| 接口路径 | /api/v1/material/upload_picture |
| 请求方式 | POST                            |
| 参数     | MultipartFile                   |
| 响应结果 | ResponseResult                  |

MultipartFile  ：Springmvc指定的文件接收类型

ResponseResult  ：

成功需要回显图片，返回素材对象

```json
{
  "host":null,
  "code":200,
  "errorMessage":"操作成功",
  "data":{
    "id":52,
    "userId":1102,
    "url":"http://192.168.200.130:9000/leadnews/2021/04/26/a73f5b60c0d84c32bfe175055aaaac40.jpg",
    "type":0,
    "isCollection":0,
    "createdTime":"2021-01-20T16:49:48.443+0000"
  }
}
```

失败：

- 参数失效
- 文章上传失败

##### 2.2.5)自媒体微服务集成heima-file-starter

①：导入heima-file-starter

```xml
<dependencies>
    <dependency>
        <groupId>com.heima</groupId>
        <artifactId>heima-file-starter</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

②：在自媒体微服务的配置中心添加以下配置：

```yaml
minio:
  accessKey: minio
  secretKey: minio123
  bucket: leadnews
  endpoint: http://192.168.200.130:9000
  readPath: http://192.168.200.130:9000
```

##### 2.2.6)准备阶段

- 导入资料中的“素材和新闻实体类”
- 导入资料中的“类\mapper“和“类\service”

##### 2.2.7)具体实现-第一阶段

①：创建MaterialController

```java
import com.heima.model.common.dtos.ResponseResult;
import com.heima.wemedia.service.WmMaterialService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

/**
 * @author itheima
 * @since 2022-07-10
 */
@RestController
@RequestMapping("/api/v1/material")
public class MaterialController {

    @Autowired
    private WmMaterialService wmMaterialService;

    @PostMapping("/upload_picture")
    public ResponseResult uploadPicture(MultipartFile multipartFile) throws IOException {
        return wmMaterialService.upload(multipartFile);
    }

}
```

②：service

```java
package com.heima.wemedia.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmMaterial;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface WmMaterialService extends IService<WmMaterial> {

    ResponseResult upload(MultipartFile file) throws IOException;
}
```

③：serviceImpl 业务代码实现

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.file.service.FileStorageService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.service.WmMaterialService;
import com.heima.wemedia.thread.WmUserThreadLocal;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Date;

@Slf4j
@Service
@Transactional
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial> implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private WmMaterialMapper wmMaterialMapper;

    @Override
    public ResponseResult upload(MultipartFile file) throws IOException {
        // 调用mino上传接口，进行上传操作
        // 文件名构成：不重复的文件名 + 文件后缀
        // images/png
        String contentType = file.getContentType();
        if (StringUtils.isEmpty(contentType)) {
            log.warn("图片格式有误");
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_IMAGE_FORMAT_ERROR);
        }

        // 解析图片类型
        String suffixName = contentType.split("/")[1];
        String fileName = System.currentTimeMillis() + "." + suffixName;

        String url = fileStorageService.uploadImgFile("", fileName, file.getInputStream());

        // 得到上传地址，上传地址记录到数据库
        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setCreatedTime(new Date());
        wmMaterial.setType((short) 0);
        wmMaterial.setIsCollection((short) 0);
        wmMaterial.setUrl(url);
        // 暂时写0，后续再来改造
        wmMaterial.setUserId(0);
        wmMaterialMapper.insert(wmMaterial);

        // 将插入后素材信息返回给前端

        return ResponseResult.okResult(wmMaterial);
    }
}
```

##### 2.2.8)具体实现-第二阶段

该阶段主要从网关获取用户id，然后传递给媒体服务，写入数据库

①：改造网关heima-leadnews-wemedia-gateway的全局过滤器

```java
package com.heima.wemedia.gateway.filter;


import com.heima.wemedia.gateway.util.AppJwtUtil;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.util.function.Consumer;

@Component
@Slf4j
public class AuthorizeFilter implements Ordered, GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //1.获取request和response对象
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        //2.判断是否是登录
        if(request.getURI().getPath().contains("/login")){
            //放行
            return chain.filter(exchange);
        }

        //3.获取token
        String token = request.getHeaders().getFirst("token");

        //4.判断token是否存在
        if(StringUtils.isBlank(token)){
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //5.判断token是否有效
        try {
            Claims claimsBody = AppJwtUtil.getClaimsBody(token);
            //是否是过期
            int result = AppJwtUtil.verifyToken(claimsBody);
            if(result == 1 || result  == 2){
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            }
            
            // 获取用户id（关键步骤一）
            Integer id = (Integer) claimsBody.get("id");

            // 将userId添加到请求头上（关键步骤二）
            ServerHttpRequest requestNew = request.mutate().headers(new Consumer<HttpHeaders>() {
                @Override
                public void accept(HttpHeaders httpHeaders) {
                    httpHeaders.add("userId", id.toString());
                }
            }).build();

            // 刷新请求头（关键步骤三）
            exchange.mutate().request(requestNew).build();
        } catch (Exception e) {
            e.printStackTrace();
        }

        //6.放行
        return chain.filter(exchange);
    }

    /**
     * 优先级设置  值越小  优先级越高
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }
}
```

②：改造heima-leadnews-wemedia项目，添加ThreadLocal类

```java
package com.heima.wemedia.thread;

import com.heima.model.wemedia.pojos.WmUser;

/**
 * @author itheima
 * @since 2022-07-10
 */
public class WmUserThreadLocal {

    // 1. 声明一个ThreadLocal类型的变量
    private static ThreadLocal<WmUser> userThreadLocal = new ThreadLocal<>();

    // 2. 为这个变量配置一对 get set方法
    public static WmUser get() {
        return userThreadLocal.get();
    }

    public static void set(WmUser wmUser) {
        userThreadLocal.set(wmUser);
    }

    // 3. 为这个变量配置一个 remove 方法
    public static void remove() {
        userThreadLocal.remove();
    }

}
```

③：改造heima-leadnews-wemedia项目，添加拦截器

```java
package com.heima.wemedia.interceptor;

import com.heima.model.wemedia.pojos.WmUser;
import com.heima.wemedia.thread.WmUserThreadLocal;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * @author itheima
 * @since 2022-07-10
 */
@Slf4j
public class TokenInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 获取请求头
        // 通过请求头获取userId
        String userId = request.getHeader("userId");

        // 判空 -> 阻止 -> return false
        if (StringUtils.isEmpty(userId)) {
            log.warn("用户没有登录");
            return false;
        }

        // 不为空 -> 存放到ThreadLocal
        // 1. 创建ThreadLocal类（get、set）
        // 2. 调用ThreadLocal类的set方法，往里面存储数据
        WmUser wmUser = new WmUser();
        wmUser.setId(Integer.parseInt(userId));
        WmUserThreadLocal.set(wmUser);

        return true;
    }
}
```

④：为拦截器配置拦截规则

```java
package com.heima.wemedia.config;

import com.heima.wemedia.interceptor.TokenInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new TokenInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns("/login/in");
    }
}
```

⑤：改造上传方法，通过ThreadLocal获取用户id

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.file.service.FileStorageService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.service.WmMaterialService;
import com.heima.wemedia.thread.WmUserThreadLocal;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Date;

@Slf4j
@Service
@Transactional
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial> implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private WmMaterialMapper wmMaterialMapper;

    @Override
    public ResponseResult upload(MultipartFile file) throws IOException {
        //.. 以上代码省略

        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setCreatedTime(new Date());
        wmMaterial.setType((short) 0);
        wmMaterial.setIsCollection((short) 0);
        wmMaterial.setUrl(url);
        // 改造这步，从ThreadLocal获取用户id（关键步骤）
        wmMaterial.setUserId(WmUserThreadLocal.get().getId());
        wmMaterialMapper.insert(wmMaterial);

        return ResponseResult.okResult(wmMaterial);
    }
}
```



#### 2.2)素材列表查询

##### 2.2.1)接口定义

|          | **说明**              |
| -------- | --------------------- |
| 接口路径 | /api/v1/material/list |
| 请求方式 | POST                  |
| 参数     | WmMaterialDto         |
| 响应结果 | ResponseResult        |

WmMaterialDto  ：

```java
@Data
public class WmMaterialDto extends PageRequestDto {

    /**
     * 1 收藏
     * 0 未收藏
     */
    private Short isCollection;
}
```

ResponseResult  :

```json
{
  "host":null,
  "code":200,
  "errorMessage":"操作成功",
  "data":[
    {
    "id":52,
      "userId":1102,
      "url":"http://192.168.200.130:9000/leadnews/2021/04/26/ec893175f18c4261af14df14b83cb25f.jpg",
      "type":0,
      "isCollection":0,
      "createdTime":"2021-01-20T16:49:48.000+0000"
    },
    ....
  ],
  "currentPage":1,
  "size":20,
  "total":0
}
```

##### 2.2.2)功能实现

①：在WmMaterialController类中新增方法

```java
@PostMapping("/list")
public ResponseResult findList(@RequestBody WmMaterialDto dto){
    return null;
}
```

②：mapper已定义

③：业务层

在WmMaterialService中新增方法

```java
/**
     * 查询所有素材
     * @param dto dto
     * @return ResponseResult
     */
ResponseResult findList(WmMaterialDto dto);
```

实现方法：

```java
@Override
public ResponseResult findList(WmMaterialDto dto) {
    if(dto == null) {
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_REQUIRE);
    }
    Integer page = dto.getPage();
    Integer size = dto.getSize();
    Short isCollection = dto.getIsCollection();

    // 构造查询条件
    LambdaQueryWrapper<WmMaterial> wrapper = new LambdaQueryWrapper<>();

    // 是否收藏
    wrapper.eq(isCollection != null && isCollection != 0, WmMaterial::getIsCollection, isCollection);

    // 查询当前用户
    wrapper.eq(WmMaterial::getUserId, WmUserThreadLocal.get().getId());

    // 构建排序条件
    wrapper.orderByDesc(WmMaterial::getCreatedTime);

    // 构建分页条件
    Page<WmMaterial> pageParam = new Page<>(page, size);
    Page<WmMaterial> pageResult = wmMaterialMapper.selectPage(pageParam, wrapper);

    // 构建返回结果
    Long total = pageResult.getTotal();
    PageResponseResult pageResponseResult = new PageResponseResult(page, size, total.intValue());
    pageResponseResult.setData(pageResult.getRecords());

    return pageResponseResult;
}
```

④：控制器：

```java
@PostMapping("/list")
public ResponseResult findList(@RequestBody WmMaterialDto dto){
    return wmMaterialService.findList(dto);
}
```

⑤：在自媒体引导类中天mybatis-plus的分页拦截器

```java
@Bean
public MybatisPlusInterceptor mybatisPlusInterceptor() {
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
    return interceptor;
}
```



### 3)自媒体文章管理

#### 3.1)查询所有频道

##### 3.1.1)需求分析

![image-20210426205631708](自媒体文章发布.assets\image-20210426205631708.png)

##### 3.1.2)表结构

wm_channel 频道信息表

![image-20210426210148580](自媒体文章发布.assets\image-20210426210148580.png)

对应实体类：

```java
package com.heima.model.wemedia.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * 频道信息表
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("wm_channel")
public class WmChannel implements Serializable {

    private static final long serialVersionUID = 1L;

    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * 频道名称
     */
    @TableField("name")
    private String name;

    /**
     * 频道描述
     */
    @TableField("description")
    private String description;

    /**
     * 是否默认频道
     * 1：默认     true
     * 0：非默认   false
     */
    @TableField("is_default")
    private Boolean isDefault;

    /**
     * 是否启用
     * 1：启用   true
     * 0：禁用   false
     */
    @TableField("status")
    private Boolean status;

    /**
     * 默认排序
     */
    @TableField("ord")
    private Integer ord;

    /**
     * 创建时间
     */
    @TableField("created_time")
    private Date createdTime;

}
```

##### 3.1.3)接口定义

|          | **说明**                 |
| -------- | ------------------------ |
| 接口路径 | /api/v1/channel/channels |
| 请求方式 | GET                      |
| 参数     | 无                       |
| 响应结果 | ResponseResult           |

ResponseResult  ：

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "操作成功",
  "data": [
    {
      "id": 4,
      "name": "java",
      "description": "java",
      "isDefault": true,
      "status": false,
      "ord": 3,
      "createdTime": "2019-08-16T10:55:41.000+0000"
    },
    Object {  ... },
    Object {  ... }
  ]
}
```

##### 3.1.4)功能实现

接口定义：

```java
package com.heima.wemedia.controller.v1;

import com.heima.model.common.dtos.ResponseResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/channel")
public class WmchannelController {

    @GetMapping("/channels")
    public ResponseResult findAll(){
        return null;
    }
}
```

mapper

```java
package com.heima.wemedia.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.wemedia.pojos.WmChannel;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface WmChannelMapper extends BaseMapper<WmChannel> {
}
```

service

```java
package com.heima.wemedia.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;

public interface WmChannelService extends IService<WmChannel> {

    /**
     * 查询所有频道
     * @return
     */
    public ResponseResult findAll();


}
```

实现类

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.service.WmChannelService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
@Slf4j
public class WmChannelServiceImpl extends ServiceImpl<WmChannelMapper, WmChannel> implements WmChannelService {


    /**
     * 查询所有频道
     * @return
     */
    @Override
    public ResponseResult findAll() {
        return ResponseResult.okResult(list());
    }
}
```

控制层

```java
package com.heima.wemedia.controller.v1;

import com.heima.model.common.dtos.ResponseResult;
import com.heima.wemedia.service.WmChannelService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/channel")
public class WmchannelController {

    @Autowired
    private WmChannelService wmChannelService;

    @GetMapping("/channels")
    public ResponseResult findAll(){
        return wmChannelService.findAll();
    }
}
```

##### 3.1.5)测试



#### 3.2)查询自媒体文章

##### 3.2.1)需求说明

![image-20210426210402672](自媒体文章发布.assets\image-20210426210402672.png)



##### 3.2.2)表结构分析

wm_news 自媒体文章表

![image-20210426210434861](自媒体文章发布.assets\image-20210426210434861.png)

对应实体类：

```java
package com.heima.model.wemedia.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import org.apache.ibatis.type.Alias;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * 自媒体图文内容信息表
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("wm_news")
public class WmNews implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * 自媒体用户ID
     */
    @TableField("user_id")
    private Integer userId;

    /**
     * 标题
     */
    @TableField("title")
    private String title;

    /**
     * 图文内容
     */
    @TableField("content")
    private String content;

    /**
     * 文章布局
            0 无图文章
            1 单图文章
            3 多图文章
     */
    @TableField("type")
    private Short type;

    /**
     * 图文频道ID
     */
    @TableField("channel_id")
    private Integer channelId;

    @TableField("labels")
    private String labels;

    /**
     * 创建时间
     */
    @TableField("created_time")
    private Date createdTime;

    /**
     * 提交时间
     */
    @TableField("submited_time")
    private Date submitedTime;

    /**
     * 当前状态
            0 草稿
            1 提交（待审核）
            2 审核失败
            3 人工审核
            4 人工审核通过
            8 审核通过（待发布）
            9 已发布
     */
    @TableField("status")
    private Short status;

    /**
     * 定时发布时间，不定时则为空
     */
    @TableField("publish_time")
    private Date publishTime;

    /**
     * 拒绝理由
     */
    @TableField("reason")
    private String reason;

    /**
     * 发布库文章ID
     */
    @TableField("article_id")
    private Long articleId;

    /**
     * //图片用逗号分隔
     */
    @TableField("images")
    private String images;

    @TableField("enable")
    private Short enable;
    
     //状态枚举类
    @Alias("WmNewsStatus")
    public enum Status{
        NORMAL((short)0),SUBMIT((short)1),FAIL((short)2),ADMIN_AUTH((short)3),ADMIN_SUCCESS((short)4),SUCCESS((short)8),PUBLISHED((short)9);
        short code;
        Status(short code){
            this.code = code;
        }
        public short getCode(){
            return this.code;
        }
    }

}
```

##### 3.2.3)接口定义

|          | **说明**          |
| -------- | ----------------- |
| 接口路径 | /api/v1/news/list |
| 请求方式 | POST              |
| 参数     | WmNewsPageReqDto  |
| 响应结果 | ResponseResult    |

WmNewsPageReqDto  :

```java
package com.heima.model.wemedia.dtos;

import com.heima.model.common.dtos.PageRequestDto;
import lombok.Data;

import java.util.Date;

@Data
public class WmNewsPageReqDto extends PageRequestDto {

    /**
     * 状态
     */
    private Short status;
    /**
     * 开始时间
     */
    private Date beginPubDate;
    /**
     * 结束时间
     */
    private Date endPubDate;
    /**
     * 所属频道ID
     */
    private Integer channelId;
    /**
     * 关键字
     */
    private String keyword;
}
```

ResponseResult  :

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "操作成功",
  "data": [
    Object { ... },
    Object { ... },
    Object { ... }
    
  ],
  "currentPage":1,
  "size":10,
  "total":21
}
```

##### 3.2.4)功能实现

①：新增WmNewsMapper

```java
package com.heima.wemedia.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.wemedia.domain.WmNews;
import com.heima.model.wemedia.domain.WmUser;
import org.springframework.stereotype.Repository;

/**
 * @author itheima
 * @since 2022-06-27
 */
@Repository
public interface WmNewsMapper extends BaseMapper<WmNews> {
}
```

②：新增WmNewsService

```java
package com.heima.wemedia.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.domain.WmChannel;
import com.heima.model.wemedia.domain.WmNews;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.dtos.WmNewsPageReqDto;

/**
 * @author itheima
 * @since 2022-06-27
 */
public interface WmNewsService extends IService<WmNews> {
    /**
     * 查询文章
     *
     * @param dto dto
     * @return ResponseResult
     */
    ResponseResult findAll(WmNewsPageReqDto dto);
}
```

实现类：

```java
package com.heima.wemedia.service;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.PageResponseResult;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.domain.WmChannel;
import com.heima.model.wemedia.domain.WmMaterial;
import com.heima.model.wemedia.domain.WmNews;
import com.heima.model.wemedia.domain.WmNewsMaterial;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.dtos.WmNewsPageReqDto;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.mapper.WmNewsMaterialMapper;
import com.heima.wemedia.thread.AuthThreadLocal;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.commons.util.IdUtils;
import org.springframework.stereotype.Service;

import java.util.*;

/**
 * @author itheima
 * @since 2022-06-27
 */
@Service
public class WmNewsServiceImpl extends ServiceImpl<WmNewsMapper, WmNews> implements WmNewsService {

    @Autowired
    private WmNewsService wmNewsService;

    @Override
    public ResponseResult findAll(WmNewsPageReqDto dto) {
        if(dto == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_REQUIRE);
        }
        
        Short status = dto.getStatus();
        String keyword = dto.getKeyword();
        Integer channelId = dto.getChannelId();
        Date endPubDate = dto.getEndPubDate();
        Date beginPubDate = dto.getBeginPubDate();

        Integer size = dto.getSize();
        Integer pageNum = dto.getPage();

        // 查询频道
        LambdaQueryWrapper<WmNews> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(channelId != null, WmNews::getChannelId, channelId);

        // 查询发布时间范围
        wrapper.between(beginPubDate != null && endPubDate != null,
                WmNews::getPublishTime, beginPubDate, endPubDate);

        // 模糊查找关键词
        wrapper.like(StringUtils.isNotEmpty(keyword), WmNews::getTitle, keyword);

        // 查询状态
        wrapper.eq(status != null, WmNews::getStatus, status);

        // 根据用户查询
        wrapper.eq(WmNews::getUserId, WmUserThreadLocal.get().getId());

        // 排序
        wrapper.orderByDesc(WmNews::getCreatedTime);

        Page<WmNews> page = new Page<>(pageNum, size);
        Page<WmNews> result = wmNewsMapper.selectPage(page, wrapper);

        // 组装返回值
        Long total = result.getTotal();
        PageResponseResult pageResult = new PageResponseResult(pageNum, size, total.intValue());
        pageResult.setData(result.getRecords());

        return pageResult;
    }
}
```

③：控制器

```java
package com.heima.wemedia.controller;

import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.dtos.WmNewsPageReqDto;
import com.heima.wemedia.service.WmNewsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;

/**
 * @author itheima
 * @since 2022-06-27
 */
@RestController
@RequestMapping("/api/v1/news")
public class NewsController {

    @Autowired
    private WmNewsService wmNewsService;

    @PostMapping("/list")
    public ResponseResult list(@RequestBody WmNewsPageReqDto dto) {
        return wmNewsService.findAll(dto);
    }
}
```

##### 3.2.5)测试

启动后端自媒体微服务和自媒体网关微服务，测试文章列表查询



#### 3.3)文章发布

##### 3.3.1)需求分析

![image-20210427014931255](自媒体文章发布.assets\image-20210427014931255.png)

##### 3.3.2)表结构分析

保存文章，除了需要wm_news表以外，还需要另外两张表

wm_news 新闻表

![image-20210426210148580](C:\space-bk\项目\黑马头条-上课版\day03\讲义\assets\image-20210426210148580.png)

wm_material 素材表

![image-20210427015037964](自媒体文章发布.assets\image-20210427015037964.png)

wm_news_material 文章素材关系表

![image-20210427015054428](自媒体文章发布.assets\image-20210427015054428.png)

![image-20210427015114994](自媒体文章发布.assets\image-20210427015114994.png)



##### 3.3.3)接口定义

|          | **说明**            |
| -------- | ------------------- |
| 接口路径 | /api/v1/news/submit |
| 请求方式 | POST                |
| 参数     | WmNewsDto           |
| 响应结果 | ResponseResult      |

WmNewsDto  

```java
package com.heima.model.wemedia.dtos;

import lombok.Data;

import java.util.Date;
import java.util.List;

@Data
public class WmNewsDto {
    
    private Integer id;
     /**
     * 标题
     */
    private String title;
     /**
     * 频道id
     */
    private Integer channelId;
     /**
     * 标签
     */
    private String labels;
     /**
     * 发布时间
     */
    private Date publishTime;
     /**
     * 文章内容
     */
    private String content;
     /**
     * 文章封面类型  0 无图 1 单图 3 多图 -1 自动
     */
    private Short type;
     /**
     * 提交时间
     */
    private Date submitedTime; 
     /**
     * 状态 提交为1  草稿为0
     */
    private Short status;
     
     /**
     * 封面图片列表 多张图以逗号隔开
     */
    private List<String> images;
}
```

前端给传递过来的json数据格式为：

```json
{
    "title":"黑马头条项目背景",
    "type":"1",//这个 0 是无图  1 是单图  3 是多图  -1 是自动
    "labels":"黑马头条",
    "publishTime":"2020-03-14T11:35:49.000Z",
    "channelId":1,
    "images":[
        "http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    ],
    "status":1,
    "content":"[
    {
        "type":"text",
        "value":"随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本项目主要着手于获取最新最热新闻资讯，通过大数据分析用户喜好精确推送咨询新闻"
    },
    {
        "type":"image",
        "value":"http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    }
]"
}
```

ResponseResult:

```json
{
	"code": 501,
	"errorMessage": "参数失效"
}

{
    "code":200,
    "errorMessage":"操作成功"
}

{
	"code": 501,
	"errorMessage": "素材引用失效"
}
```

##### 3.3.4)实现思路分析

![image-20220710214037715](assets\image-20220710214037715.png)

##### 3.3.5)功能实现

①：添加实体类

```java
package com.heima.model.wemedia.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;

/**
 * <p>
 * 自媒体图文引用素材信息表
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("wm_news_material")
public class WmNewsMaterial implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * 素材ID
     */
    @TableField("material_id")
    private Integer materialId;

    /**
     * 图文ID
     */
    @TableField("news_id")
    private Integer newsId;

    /**
     * 引用类型
            0 内容引用
            1 主图引用
     */
    @TableField("type")
    private Short type;

    /**
     * 引用排序
     */
    @TableField("ord")
    private Short ord;

}
```

②：新增控制器类

```java
package com.heima.wemedia.controller.v1;

import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.wemedia.service.WmNewsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @author itheima
 * @since 2022-07-10
 */
@RestController
@RequestMapping("/api/v1/news")
public class NewsController {

    @Autowired
    private WmNewsService wmNewsService;

    @PostMapping("/submit")
    public ResponseResult submit(@RequestBody WmNewsDto dto) {
        return wmNewsService.submit(dto);
    }
}
```

③：新增service方法

```java
package com.heima.wemedia.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.pojos.WmNews;

public interface WmNewsService extends IService<WmNews> {

    /**
     * 新闻发布
     * @param dto dto
     * @return ResponseResult
     */
    ResponseResult submit(WmNewsDto dto);

}
```

④：实现service方法

```java
package com.heima.wemedia.service.impl;


import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmNewsMaterial;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.mapper.WmNewsMaterialMapper;
import com.heima.wemedia.service.WmNewsService;
import com.heima.wemedia.thread.WmUserThreadLocal;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;

@Service
@Slf4j
@Transactional
public class WmNewsServiceImpl extends ServiceImpl<WmNewsMapper, WmNews> implements WmNewsService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    @Autowired
    private WmMaterialMapper wmMaterialMapper;

    @Autowired
    private WmNewsMaterialMapper wmNewsMaterialMapper;

    @Override
    @Transactional(rollbackFor = RuntimeException.class)
    public ResponseResult submit(WmNewsDto dto) {
        // 1. 提取新闻内容

        // 2. 插入新闻表

        // 3. 判断是否为草稿

        // 4. 提取内容图

        // 5. 提取封面图

        // 8. 自动布局

        // 6. 插入内容图

        // 7. 插入封面图

        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
}
```

⑤：提取新闻内容

```java
public WmNews wmNewsDtoToWmNews(WmNewsDto wmNewsDto) {
    if (wmNewsDto == null) {
        return null;
    }

    WmNews wmNews = new WmNews();
    //自动映射
    BeanUtils.copyProperties(wmNewsDto, wmNews);

    //处理额外的字段
    wmNews.setUserId(WmUserThreadLocal.get().getId());
    wmNews.setCreatedTime(new Date());
    wmNews.setEnable((short) 1);


    if (wmNewsDto.getType() == -1) {
        wmNews.setType(null);
    }


    List<String> images = wmNewsDto.getImages();
    if (CollectionUtils.isEmpty(images)) {
        String join = StringUtils.join(images, ",");
        wmNews.setImages(join);

    }
    return wmNews;
}
```

⑥：在主方法中调用

- 调用提取内容方法
- 调用插入数据库方法
- 判断是否为草稿

```java
@Override
@Transactional(rollbackFor = RuntimeException.class)
public ResponseResult submit(WmNewsDto dto) {
    // 1. 提取新闻的内容
    WmNews wmNews = wmNewsDtoToWmNews(wmNewsDto);
    if (wmNews == null) {
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_REQUIRE);
    }
    // 2. 插入新闻表
    int insertResult = wmNewsMapper.insert(wmNews);
    if (insertResult < 1) {
        return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR);
    }

    // 3. 判断是不是草稿(草稿 -> 返回)
    Short status = wmNewsDto.getStatus();
    if (status == 0) {
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    // 4. 提取内容图

    // 5. 提取封面图

    // 8. 自动布局

    // 6. 插入内容图

    // 7. 插入封面图

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

⑦：提取内容图方法

```java
private List<String> getContentImages(String content) {
    if (StringUtils.isEmpty(content)) {
        return new ArrayList<>();
    }

    List<String> urlList = new ArrayList<>();

    //1 将content转换为集合
    List<Map> maps = JSON.parseArray(content, Map.class);
    if (CollectionUtils.isEmpty(maps)) {
        return new ArrayList<>();
    }

    //2 将集合进行遍历
    for (Map map : maps) {
        if (CollectionUtils.isEmpty(map)) {
            continue;
        }
        Object type = map.get("type");
        if ("image".equals(type)) {
            String value = (String) map.get("value");
            urlList.add(value);
        }
    }
    //3 判断type = images 那行数据
    return urlList;
}
```

在主方法调用

```java
@Override
@Transactional(rollbackFor = RuntimeException.class)
public ResponseResult submit(WmNewsDto dto) {
    // ..前面省略

    // 4. 提取内容图
    List<String> contentImages = getContentImages(dto.getContent());

    // 5. 提取封面图
    List<String> coverImages = new ArrayList<>();

    // 8. 自动布局

    // 6. 插入内容图

    // 7. 插入封面图

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

⑧：插入素材和素材关系

```java
@Transactional(rollbackFor = RuntimeException.class)
public Boolean addMaterial(List<String> images, Integer type, Integer newsId) {
    if (CollectionUtils.isEmpty(images)) {
        log.warn("素材不能为空");
        return false;
    }

    // 1. 遍历图片集合
    for (String image : images) {
        if (StringUtils.isEmpty(image)) {
            continue;
        }

        // 2. 判断当前图片是否存在于素材表中
        LambdaQueryWrapper<WmMaterial> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(WmMaterial::getUrl, image);
        WmMaterial wmMaterial = wmMaterialMapper.selectOne(wrapper);

        Integer materialId = null;
        if (wmMaterial == null) {
            WmMaterial material = new WmMaterial();
            material.setUserId(WmUserThreadLocal.get().getId());
            material.setUrl(image);
            material.setIsCollection((short) 0);
            material.setType((short) 0);
            material.setCreatedTime(new Date());

            int materialResult = wmMaterialMapper.insert(material);
            if (materialResult < 1) {
                log.warn("素材插入失败");
                throw new RuntimeException("素材插入失败");
            }

            // 2.2 如不存在，插入素材，返回id
            materialId = material.getId();
        } else {
            // 2.1 如果已存在，返回id
            materialId = wmMaterial.getId();
        }

        // 3. 插入关系表
        WmNewsMaterial newsMaterial = new WmNewsMaterial();
        newsMaterial.setMaterialId(materialId);
        newsMaterial.setNewsId(newsId);
        newsMaterial.setType(type.shortValue());
        newsMaterial.setOrd((short) 0);

        int newMaterialResult = wmNewsMaterialMapper.insert(newsMaterial);
        if (newMaterialResult < 1) {
            throw new RuntimeException("素材关系插入失败");
        }
    }

    // 4. 返回true
    return true;
}
```

⑨：自动布局方法

```java
public List<String> autoLayout(List<String> contentImages) {
    // 从内容图获取图片，填充到封面图上
    int size = contentImages.size();
    List<String> coverImages = new ArrayList<>();

    // 判断内容图的长度
    // 长度为 0 -> 无图
    if (size == 0) {
        return coverImages;
    }
    // 长度为 1 -> 单图
    else if (size == 1) {
        coverImages.add(contentImages.get(0));
        return coverImages;
    }
    // 长度大于3 -> 多图
    else if (size > 3) {
        coverImages.addAll(contentImages.subList(0, 3));
        return coverImages;
    }

    return contentImages;
}
```

⑩：service完整代码

```java
package com.heima.wemedia.service.impl;


import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.dtos.WmNewsDto;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmNewsMaterial;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.mapper.WmNewsMaterialMapper;
import com.heima.wemedia.service.WmNewsService;
import com.heima.wemedia.thread.WmUserThreadLocal;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;

@Service
@Slf4j
@Transactional
public class WmNewsServiceImpl extends ServiceImpl<WmNewsMapper, WmNews> implements WmNewsService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    @Autowired
    private WmMaterialMapper wmMaterialMapper;

    @Autowired
    private WmNewsMaterialMapper wmNewsMaterialMapper;

    @Override
    @Transactional(rollbackFor = RuntimeException.class)
    public ResponseResult submit(WmNewsDto dto) {
        // 1. 提取新闻内容
        WmNews news = getNews(dto);

        // 2. 插入新闻表
        int newsResult = wmNewsMapper.insert(news);
        if (newsResult < 1) {
            return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR);
        }

        // 3. 判断是否为草稿
        Short status = dto.getStatus();
        if (status == 0) {
            log.info("文章为草稿，所以没有添加素材");
            return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
        }

        // 4. 提取内容图
        List<String> contentImages = getContentImages(dto.getContent());

        // 5. 如果是自动布局，要到内容图中，去提取图片作为封面图
        List<String> images = wmNewsDto.getImages();
        Short type = wmNewsDto.getType();
        List<String> coverImages = getCoverImages(type, images, contentImages);

        // 8. 自动布局
        // 如果是自动布局，就根据自动提取的封面图设置type字段
        if (wmNewsDto.getType() == -1) {
            if (coverImages.size() == 3) {
                wmNews.setType((short) 3);
                // 0726 添加封面图回写逻辑
                wmNews.setImages(StringUtils.join(coverImages.subList(0, 3), ","));
            }

            else if (coverImages.size() < 3 && contentImages.size() > 0) {
                wmNews.setType((short) 1);
                // 0726 添加封面图回写逻辑
                wmNews.setImages(coverImages.get(0));
            }

            else {
                wmNews.setType((short) 0);
            }
        }

        // 6. 插入内容图
        addMaterial(contentImages, 1, news.getId());

        // 7. 插入封面图
        addMaterial(coverImages, 0, news.getId());

        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
    
    public WmNews getNews(WmNewsDto dto) {
        if (dto == null) {
            log.warn("dto不能为空");
            return null;
        }

        WmNews wmNews = new WmNews();
        // 1. dto和wmNews相同字段进行赋值
        BeanUtils.copyProperties(dto, wmNews);

        // 2. 处理差异的字段
        if (dto.getType() == -1) {
            wmNews.setType(null);
        }

        List<String> images = dto.getImages();
        String imagesString = StringUtils.join(images, ",");
        wmNews.setImages(imagesString);
        wmNews.setCreatedTime(new Date());
        wmNews.setUserId(WmUserThreadLocal.get().getId());
        // 3. 返回wmNews

        return wmNews;
    }

    public List<String> getContentImages(String content) {
        // 1. 把content转成集合
        List<Map> maps = JSON.parseArray(content, Map.class);
        if (CollectionUtils.isEmpty(maps)) {
            log.warn("内容为空");
            return null;
        }

        List<String> imageList = new ArrayList<>();

        // 2. 遍历集合，找到里面type = image数据
        for (Map map : maps) {
            if (CollectionUtils.isEmpty(maps)) {
                continue;
            }

            Object type = map.get("type");
            if ("image".equals(type)) {
                try {
                    String value = (String) map.get("value");
                    imageList.add(value);
                } catch (Exception e) {
                    log.warn("value解析失败");
                    continue;
                }
            }
        }

        // 3. 提取value字段，形成一个List

        // 4. 把集合返回回去
        return imageList;
    }

    @Transactional(rollbackFor = RuntimeException.class)
    public Boolean addMaterial(List<String> images, Integer type, Integer newsId) {
        if (CollectionUtils.isEmpty(images)) {
            log.warn("素材不能为空");
            return false;
        }

        // 1. 遍历图片集合
        for (String image : images) {
            if (StringUtils.isEmpty(image)) {
                continue;
            }

            // 2. 判断当前图片是否存在于素材表中
            LambdaQueryWrapper<WmMaterial> wrapper = new LambdaQueryWrapper<>();
            wrapper.eq(WmMaterial::getUrl, image);
            WmMaterial wmMaterial = wmMaterialMapper.selectOne(wrapper);

            Integer materialId = null;
            if (wmMaterial == null) {
                WmMaterial material = new WmMaterial();
                material.setUserId(WmUserThreadLocal.get().getId());
                material.setUrl(image);
                material.setIsCollection((short) 0);
                material.setType((short) 0);
                material.setCreatedTime(new Date());

                int materialResult = wmMaterialMapper.insert(material);
                if (materialResult < 1) {
                    log.warn("素材插入失败");
                    throw new RuntimeException("素材插入失败");
                }

                // 2.2 如不存在，插入素材，返回id
                materialId = material.getId();
            } else {
                // 2.1 如果已存在，返回id
                materialId = wmMaterial.getId();
            }

            // 3. 插入关系表
            WmNewsMaterial newsMaterial = new WmNewsMaterial();
            newsMaterial.setMaterialId(materialId);
            newsMaterial.setNewsId(newsId);
            newsMaterial.setType(type.shortValue());
            newsMaterial.setOrd((short) 0);

            int newMaterialResult = wmNewsMaterialMapper.insert(newsMaterial);
            if (newMaterialResult < 1) {
                throw new RuntimeException("素材关系插入失败");
            }
        }

        // 4. 返回true
        return true;
    }
}
```

##### 3.3.6)测试
